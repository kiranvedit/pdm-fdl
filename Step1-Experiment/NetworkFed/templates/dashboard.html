<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetworkFed Control Dashboard - Federated Learning PDM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-connected {
            background-color: #48bb78;
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background-color: #f56565;
        }

        .status-warning {
            background-color: #ed8936;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-weight: bold;
            color: #2d3748;
        }

        .button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: linear-gradient(135deg, #3182ce, #2c5282);
        }

        .button-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group select, .form-group input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .progress-container {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }

        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .log-timestamp {
            color: #90cdf4;
        }

        .log-info {
            color: #68d391;
        }

        .log-warning {
            color: #fbb948;
        }

        .log-error {
            color: #fc8181;
        }

        .sites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .site-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #48bb78;
        }

        .site-name {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .site-info {
            font-size: 12px;
            color: #718096;
        }

        .training-metrics {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-title {
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .metric-number {
            font-size: 28px;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .timestamp {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 12px;
            z-index: 1000;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid #cbd5e0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="timestamp" id="timestamp"></div>
    
    <div class="container">
        <div class="header">
            <h1>üè≠ NetworkFed Control Dashboard</h1>
            <p>Federated Learning Predictive Maintenance System</p>
        </div>

        <!-- Status Overview -->
        <div class="dashboard-grid">
            <div class="card">
                <h3>
                    <span class="status-indicator" id="central-status"></span>
                    Central Orchestrator
                </h3>
                <div class="metric">
                    <span>Status</span>
                    <span class="metric-value" id="central-status-text">Initializing...</span>
                </div>
                <div class="metric">
                    <span>Device</span>
                    <span class="metric-value" id="device-info">CPU</span>
                </div>
                <div class="metric">
                    <span>Model Server</span>
                    <span class="metric-value" id="model-server-status">Disconnected</span>
                </div>
            </div>

            <div class="card">
                <h3>
                    <span class="status-indicator" id="sites-status"></span>
                    Connected Sites
                </h3>
                <div class="metric">
                    <span>Factory DataSites</span>
                    <span class="metric-value" id="connected-count">0</span>
                </div>
                <div class="metric">
                    <span>Data Distributed</span>
                    <span class="metric-value" id="data-status">No</span>
                </div>
                <div class="metric">
                    <span>Training Ready</span>
                    <span class="metric-value" id="training-ready">No</span>
                </div>
            </div>

            <div class="card">
                <h3>
                    <span class="status-indicator" id="training-status"></span>
                    Training Progress
                </h3>
                <div class="metric">
                    <span>Current Round</span>
                    <span class="metric-value" id="current-round">0</span>
                </div>
                <div class="metric">
                    <span>Max Rounds</span>
                    <span class="metric-value" id="max-rounds">10</span>
                </div>
                <div class="metric">
                    <span>Active</span>
                    <span class="metric-value" id="training-active">No</span>
                </div>
            </div>

            <div class="card">
                <h3>
                    <span class="status-indicator status-connected"></span>
                    System Health
                </h3>
                <div class="metric">
                    <span>PyTorch</span>
                    <span class="metric-value" id="pytorch-status">Loading...</span>
                </div>
                <div class="metric">
                    <span>PySyft</span>
                    <span class="metric-value" id="pysyft-status">Loading...</span>
                </div>
                <div class="metric">
                    <span>GPU Available</span>
                    <span class="metric-value" id="gpu-status">Checking...</span>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h3>üéõÔ∏è Experiment Configuration</h3>
            <div class="config-grid">
                <div class="form-group">
                    <label>Model Type</label>
                    <select id="model-type">
                        <option value="cnn">CNN (93.95% accuracy)</option>
                        <option value="lstm">LSTM (94.15% accuracy)</option>
                        <option value="hybrid">Hybrid CNN-LSTM (92.20% accuracy)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>FL Algorithm</label>
                    <select id="algorithm">
                        <option value="fedavg">FedAvg</option>
                        <option value="fedprox">FedProx</option>
                        <option value="feddyn">FedDyn</option>
                        <option value="fednova">FedNova</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data Distribution</label>
                    <select id="distribution">
                        <option value="iid">IID</option>
                        <option value="non_iid">Non-IID</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Communication</label>
                    <select id="communication">
                        <option value="standard">Standard</option>
                        <option value="secure">Secure (DP + BFT)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Rounds</label>
                    <input type="number" id="rounds" value="10" min="1" max="100">
                </div>
                <div class="form-group">
                    <label>Learning Rate</label>
                    <input type="number" id="learning-rate" value="0.001" step="0.0001" min="0.0001" max="1">
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="button" onclick="updateConfig()">üìã Update Configuration</button>
                <button class="button button-secondary" onclick="loadData()">üìä Load & Distribute Data</button>
                <button class="button button-secondary" onclick="prepareTraining()" id="prepare-btn">üîß Prepare Training</button>
                <button class="button" onclick="startTraining()" id="start-btn" disabled>‚ñ∂Ô∏è Start Training</button>
                <button class="button button-danger" onclick="stopTraining()" id="stop-btn" disabled>‚èπÔ∏è Stop Training</button>
                <button class="button button-danger" onclick="resetDashboard()">üîÑ Reset</button>
            </div>
        </div>

        <!-- Training Progress -->
        <div class="progress-container" id="progress-container" style="display: none;">
            <h3>üìà Training Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <span id="progress-text">Ready to start training...</span>
            </div>
        </div>

        <!-- Connected Sites -->
        <div class="card">
            <h3>üè≠ Factory DataSites</h3>
            <div class="sites-grid" id="sites-container">
                <div class="loading">Loading factory sites...</div>
            </div>
        </div>

        <!-- Training Metrics -->
        <div class="training-metrics" id="metrics-container" style="display: none;">
            <h3>üìä Training Metrics</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">Global Accuracy</div>
                    <div class="metric-number" id="global-accuracy">0.00%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Global Loss</div>
                    <div class="metric-number" id="global-loss">0.000</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Participating Clients</div>
                    <div class="metric-number" id="participating-clients">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Round Time (s)</div>
                    <div class="metric-number" id="round-time">0.0</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="accuracy-chart"></canvas>
            </div>
        </div>

        <!-- Console Log -->
        <div class="log-container" id="log-container">
            <div class="log-entry">
                <span class="log-timestamp">[00:00:00]</span>
                <span class="log-info">WebDashboard initialized - waiting for updates...</span>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket = null;
        let dashboardData = {};
        let accuracyChart = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeChart();
            updateTimestamp();
            setInterval(updateTimestamp, 1000);
            
            // Request initial update
            setTimeout(() => {
                if (socket) {
                    socket.emit('request_update');
                }
            }, 1000);
        });

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                addLog('Connected to WebDashboard server', 'info');
                socket.emit('request_update');
            });
            
            socket.on('disconnect', function() {
                addLog('Disconnected from WebDashboard server', 'warning');
            });
            
            socket.on('dashboard_update', function(data) {
                dashboardData = data;
                updateDashboard(data);
            });
            
            socket.on('status_update', function(data) {
                dashboardData = data;
                updateDashboard(data);
            });
            
            socket.on('site_connected', function(data) {
                addLog(`Factory site ${data.factory_name} connected on port ${data.factory_port}`, 'info');
                socket.emit('request_update');
            });
            
            socket.on('site_disconnected', function(data) {
                addLog(`Factory site ${data.factory_name} disconnected`, 'warning');
                socket.emit('request_update');
            });
        }

        function updateDashboard(data) {
            // Update status indicators
            updateElement('central-status-text', data.central_orchestrator_status || 'unknown');
            updateStatusIndicator('central-status', data.model_server_connected);
            
            updateElement('device-info', data.gpu_info?.central_orchestrator || 'CPU');
            updateElement('model-server-status', data.model_server_connected ? 'Connected' : 'Disconnected');
            
            updateElement('connected-count', data.connected_clients || 0);
            updateElement('data-status', data.data_loaded ? 'Yes' : 'No');
            updateElement('training-ready', data.model_loaded ? 'Yes' : 'No');
            
            updateElement('current-round', data.current_round || 0);
            updateElement('max-rounds', data.max_rounds || 10);
            updateElement('training-active', data.training_active ? 'Yes' : 'No');
            
            // Update system health
            updateElement('pytorch-status', data.gpu_info?.gpu_enabled ? 'Available' : 'CPU Only');
            updateElement('pysyft-status', 'Available'); // Assume available if dashboard is running
            updateElement('gpu-status', data.gpu_info?.gpu_enabled ? 'Yes' : 'No');
            
            // Update status indicators
            updateStatusIndicator('sites-status', data.connected_clients > 0);
            updateStatusIndicator('training-status', data.training_active);
            
            // Update connected sites
            updateConnectedSites(data.connected_sites || []);
            
            // Update training progress
            updateTrainingProgress(data);
            
            // Update training metrics
            if (data.training_metrics) {
                updateTrainingMetrics(data.training_metrics);
            }
            
            // Update button states
            updateButtonStates(data);
        }

        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function updateStatusIndicator(id, isConnected) {
            const element = document.getElementById(id);
            if (element) {
                element.className = `status-indicator ${isConnected ? 'status-connected' : 'status-disconnected'}`;
            }
        }

        function updateConnectedSites(sites) {
            const container = document.getElementById('sites-container');
            if (!container) return;
            
            if (sites.length === 0) {
                container.innerHTML = '<div class="loading">No factory sites connected</div>';
                return;
            }
            
            container.innerHTML = sites.map(site => `
                <div class="site-card">
                    <div class="site-name">üè≠ ${site}</div>
                    <div class="site-info">Status: Connected</div>
                    <div class="site-info">Ready for training</div>
                </div>
            `).join('');
        }

        function updateTrainingProgress(data) {
            const container = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            if (data.training_active) {
                container.style.display = 'block';
                const progress = ((data.current_round || 0) / (data.max_rounds || 10)) * 100;
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `Round ${data.current_round || 0} of ${data.max_rounds || 10}`;
            } else {
                container.style.display = 'none';
            }
        }

        function updateTrainingMetrics(metrics) {
            const container = document.getElementById('metrics-container');
            if (!metrics) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            updateElement('global-accuracy', `${(metrics.global_accuracy * 100).toFixed(2)}%`);
            updateElement('global-loss', metrics.global_loss.toFixed(3));
            updateElement('participating-clients', metrics.participating_clients);
            updateElement('round-time', metrics.round_time.toFixed(1));
            
            // Update chart
            if (accuracyChart && metrics.round) {
                const accuracy = (metrics.global_accuracy * 100).toFixed(2);
                
                accuracyChart.data.labels.push(`Round ${metrics.round}`);
                accuracyChart.data.datasets[0].data.push(accuracy);
                
                // Keep only last 10 points
                if (accuracyChart.data.labels.length > 10) {
                    accuracyChart.data.labels.shift();
                    accuracyChart.data.datasets[0].data.shift();
                }
                
                accuracyChart.update();
            }
        }

        function updateButtonStates(data) {
            const prepareBtn = document.getElementById('prepare-btn');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            prepareBtn.disabled = !data.data_loaded || data.training_active;
            startBtn.disabled = !data.model_loaded || data.training_active;
            stopBtn.disabled = !data.training_active;
        }

        function initializeChart() {
            const ctx = document.getElementById('accuracy-chart').getContext('2d');
            accuracyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Global Accuracy (%)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Accuracy (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Training Round'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Federated Learning Training Progress'
                        }
                    }
                }
            });
        }

        function updateTimestamp() {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            document.getElementById('timestamp').textContent = `‚è∞ ${timestamp}`;
        }

        function addLog(message, type = 'info') {
            const container = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-${type}">${message}</span>
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 50 log entries
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }

        // API Functions
        async function updateConfig() {
            const config = {
                model_type: document.getElementById('model-type').value,
                algorithm: document.getElementById('algorithm').value,
                distribution: document.getElementById('distribution').value,
                communication: document.getElementById('communication').value,
                rounds: parseInt(document.getElementById('rounds').value),
                learning_rate: parseFloat(document.getElementById('learning-rate').value)
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    addLog('Configuration updated successfully', 'info');
                } else {
                    addLog(`Configuration update failed: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`Configuration update error: ${error.message}`, 'error');
            }
        }

        async function loadData() {
            try {
                addLog('Loading and distributing data...', 'info');
                const response = await fetch('/api/load_data', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    addLog('Data loaded and distributed successfully', 'info');
                } else {
                    addLog(`Data loading failed: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`Data loading error: ${error.message}`, 'error');
            }
        }

        async function prepareTraining() {
            try {
                addLog('Preparing federated training...', 'info');
                const response = await fetch('/api/prepare_training', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    addLog('Training preparation completed', 'info');
                } else {
                    addLog(`Training preparation failed: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`Training preparation error: ${error.message}`, 'error');
            }
        }

        async function startTraining() {
            try {
                addLog('Starting federated training...', 'info');
                const response = await fetch('/api/start_training', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    addLog('Federated training started', 'info');
                    document.getElementById('metrics-container').style.display = 'block';
                } else {
                    addLog(`Training start failed: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`Training start error: ${error.message}`, 'error');
            }
        }

        async function stopTraining() {
            try {
                addLog('Stopping federated training...', 'warning');
                const response = await fetch('/api/stop_training', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    addLog('Federated training stopped', 'warning');
                } else {
                    addLog(`Training stop failed: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`Training stop error: ${error.message}`, 'error');
            }
        }

        async function resetDashboard() {
            try {
                addLog('Resetting dashboard...', 'warning');
                const response = await fetch('/api/reset', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    addLog('Dashboard reset completed', 'info');
                    // Reset chart
                    if (accuracyChart) {
                        accuracyChart.data.labels = [];
                        accuracyChart.data.datasets[0].data = [];
                        accuracyChart.update();
                    }
                    // Hide metrics
                    document.getElementById('metrics-container').style.display = 'none';
                } else {
                    addLog(`Dashboard reset failed: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`Dashboard reset error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
